version: '3.8'

services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.25
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_ADVERTISE_CLIENT_URLS=http://127.0.0.1:2379
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
    network_mode: host
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health", "--endpoints=127.0.0.1:2379"]
      interval: 5s
      timeout: 5s
      retries: 12

  minio:
    image: minio/minio:RELEASE.2024-05-28T17-19-04Z
    environment:
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    command: server /data
    network_mode: host
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 12

  milvus:
    image: ${MILVUS_IMAGE:-milvusdb/milvus:v2.6.8}
    environment:
      - ETCD_ENDPOINTS=127.0.0.1:2379
      - MINIO_ADDRESS=127.0.0.1:9000
      - MINIO_ACCESS_KEY_ID=minioadmin
      - MINIO_SECRET_ACCESS_KEY=minioadmin
      - COMMON_STORAGETYPE=local
    volumes:
      - ./user.yaml:/milvus/configs/user.yaml
    command: milvus run standalone
    network_mode: host
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9091/healthz"]
      interval: 10s
      timeout: 10s
      retries: 18
      start_period: 30s
